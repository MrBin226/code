clc;
clear;
close all;
%% 模型参数设定
cij=[0.00	1181.70	1103.39	1773.27	1291.48	745.90	1672.57	1155.25	1936.74;
    1239.19	0.00	765.23	1391.79	1251.33	945.61	1514.24	1345.17	1818.26;
    1386.31	1380.14	0.00	1621.85	1398.94	801.54	1593.58	1835.40	1525.45;
    1209.05	940.66	1127.69	0.00	1399.26	989.33	1386.38	1560.13	1836.36;
    1154.98	971.03	981.71	1544.64	0.00	0.00	1099.32	1762.00	1781.85;
    1230.74	1220.92	618.33	1663.87	0.00	0.00	0.00	1151.61	1364.22;
    923.17	1192.72	1162.24	1025.54	1144.38	0.00	0.00	1242.38	1402.74;
    2079.45	1032.34	1046.86	1570.53	972.88	1475.09	1455.04	0.00	1238.76;
    1384.93	1284.76	1553.96	1714.67	1368.00	1350.58	1902.02	1583.37	0.00];
% cij=zeros(9,9);
% for i=1:9
%     for j=1:9
%         if i~=j
%             cij(i,j)=0.5;
%         end
%     end
% end
fij=[0	0	40	0	0	35	0	0	0;
    0	0	50	0	0	40	25	0	0;
    0	0	0	0	0	0	0	0	0;
    0	0	60	0	0	0	45	0	0;
    0	0	70	0	0	0	35	0	0;
    0	0	0	0	0	0	0	0	0;
    0	0	0	0	0	0	0	0	0;
    0	0	30	0	0	0	25	0	0;
    0	0	60	0	0	35	30	0	0];
lij=[0	12.405	140.406	37.352	48.098	97.004	57.236	48.159	56.197;
    12.405	0	128.223	25.279	35.712	85.310	44.848	46.270	57.919;
    140.406	128.223	0	103.056	92.947	72.166	85.616	126.470	143.204;
    37.352	25.279	103.056	0	12.306	66.895	22.677	45.592	62.339;
    48.098	35.712	92.947	12.306	0	54.886	10.401	55.944	73.311;
    97.004	85.310	72.166	66.895	54.886	0	44.609	109.859	127.650;
    57.236	44.848	85.616	22.677	10.401	44.609	0	65.635	83.231;
    48.159	46.270	126.470	45.592	55.944	109.859	65.635	0	18.075;
    56.197	57.919	143.204	62.339	73.311	127.650	83.231	18.075	0];
tij=[0	0.207	2.340	0.623	0.802	1.617	0.954	0.803	0.937;
    0.207	0	2.137	0.421	0.595	1.422	0.747	0.771	0.965;
    2.340	2.137	0	1.718	1.549	1.203	1.427	2.108	2.387;
    0.623	0.421	1.718	0	0.205	1.115	0.378	0.760	1.039;
    0.802	0.595	1.549	0.205	0	0.915	0.173	0.932	1.222;
    1.617	1.422	1.203	1.115	0.915	0	0.743	1.831	2.128;
    0.954	0.747	1.427	0.378	0.173	0.743	0	1.094	1.387;
    0.803	0.771	2.108	0.760	0.932	1.831	1.094	0	0.301;
    0.937	0.965	2.387	1.039	1.222	2.128	1.387	0.301	0];
% Tij=[0	0.827	9.360	2.490	3.207	6.467	3.816	3.211	3.746;
%     0.827	0	8.548	1.685	2.381	5.687	2.990	3.085	3.861;
%     9.360	8.548	0	6.870	6.196	4.811	5.708	8.431	9.547;
%     2.490	1.685	6.870	0	0.820	4.460	1.512	3.039	4.156;
%     3.207	2.381	6.196	0.820	0	3.659	0.693	3.730	4.887;
%     6.467	5.687	4.811	4.460	3.659	0	2.974	7.324	8.510;
%     3.816	2.990	5.708	1.512	0.693	2.974	0	4.376	5.549;
%     3.211	3.085	8.431	3.039	3.730	7.324	4.376	0	1.205;
%     3.746	3.861	9.547	4.156	4.887	8.510	5.549	1.205	0];
a1=0.6;
a2=0.5;
c_k=[550	570	540	520	510	500	530	520	510];
% c_kt=[150	140	130	110	100	120	130	110	140];
c_kt=zeros(1,9)+50;
% t_k=[0.2	0.1	0.1	0.1	0.1	0.2	0.1	0.1	0.1];
P=[2 3 4];

P_n=length(P);%枢纽个数

%% 遗传算法参数设定
popsize=30;%种群大小
CROSSOVERRATE = 0.9;%杂交率
SELECTRATE = 0.5;%选择率
VARIATIONRATE = 0.05;%变异率
iterMAX=30;%迭代次数

%% 计算初始和终止节点
first_end=con_node(fij);

%% 初始化种群
pop=initPop(popsize,P_n);

mean_fitness=zeros(iterMAX,1);
best_fitness=zeros(iterMAX,1);
%% 迭代
for k=1:iterMAX
    %计算成本
    fitness=cal_cost(pop,cij,fij,lij,a1,a2,first_end,P,c_kt,c_k);
    %选择
    new_pop = select(pop,fitness,SELECTRATE);
    %交叉
    new_pop = cross(new_pop,CROSSOVERRATE);
    %变异
    new_pop = mutation(new_pop,VARIATIONRATE);
    all_pop=[pop;new_pop];
    fitness=cal_cost(all_pop,cij,fij,lij,a1,a2,first_end,P,c_kt,c_k);
    [f,index]=sort(fitness);
    pop=all_pop(index(1:popsize),:);
    fprintf('第%d次迭代，最优适应度为%.2f\n',k,f(1));
    mean_fitness(k)=mean(f(1:popsize));
    best_fitness(k)=f(1);
end
route=decode(pop(1,:),cij,fij,lij,a1,a2,first_end,P,c_kt);

m_node=P(pop(1,:)==1);
if isempty(m_node)
    fprintf('无中转站点');
else
    fprintf('中转站点为：');
    for i=1:length(m_node)
        fprintf('%d   ',m_node(i));
    end
end
fprintf('\n');
draw_route(route,m_node);
figure(2)
hold on
xlabel('迭代次数');
ylabel('适应度');
title('种群适应度变化曲线');
plot(mean_fitness);
plot(best_fitness);
legend('平均适应度','最优适应度');
hold off



